# Building and attesting are performed in two separated Jobs to elevate to SLSA3.
# This workflow requires a `./slsa_build.sh` at the repository root to run your build.

# This workflow invokes your Build Action at `.github/actions/slsa-build`'s `action.yml`
# Example `.github/actions/slsa-build/action.yml`

# name: SLSA3 Build
# description: >-
#   A named Action that you have at in your source repo .github/actions/slsa-build/action.yml.
#   The Workflow `attest-build-provenance-sls3-rw` will search invoke this action to run
#   your build. You man have any steps or invoke yet another Action.
# runs:
#   using: composite
#   steps:
#     - name: build
#       shell: bash
#       run: make release

# Example workflow invocation:

# jobs:
#   build-and-attest:
#     permissions:
#       id-token: write
#       attestations: write
#       contents: read
#     uses: ramonpetgrave/github-build-attestations-rw/.github/workflows/attest-build-provenance-slsa3-rw.yml@dev
#     with:
#       build-runner-label: ubuntu-latest
#       subject-path: |
#         ./gundam
#         ./myhero

name: Attest Build Provenance SLSA3 Resuable Workflow

permissions: {}

on:
  workflow_call:
    inputs:
      build-artifact-name:
        description: >
          The name of Github workflow artifact to store the subject files
        default: slsa3_build_artifact
        required: false
        type: string
      build-attestation-name:
        description: >
          The name of Github workflow artifact to store the attestation bundle file
        default: slsa3_build_attestation
        required: false
        type: string
      subject-path:
        description: >
          Path to the artifact serving as the subject of the attestation. May contain a
          glob pattern or list of paths (total subject count cannot exceed 2500).
          See https://github.com/actions/upload-artifact?tab=readme-ov-file#examples.
        required: true
        type: string
      show-summary:
        description: >
          Whether to attach a list of generated attestations to the workflow run
          summary page. Defaults to true.
        default: true
        required: false
        type: boolean
      build-github-token:
        description: >
          The GitHub token used as environment variable GH_TOKEN to ./slsa_build.sh.
        default: ''
        required: false
        type: string
      build-runner-label:
        description: >
          The runner label to pass to `runs-on:`. e.g., "ubuntu-latest". 
        required: true
        type: string
      test-verify-signer-workflow-cert-identity:
        description: >
          The signer workflow's --cert-identity to use in the `verify` Job, to make sure the
          artifacts and attestations can be verified with the Github CLI.
        required: false
        default: https://github.com/ramonpetgrave/github-build-attestations-rw/.github/workflows/attest-build-provenance-slsa3-rw.yml@refs/heads/dev
        type: string
      stub-workflow-cert-identity:
        description: >
          The Build sub-reusable workflow's --cert-identity to use in the `attest` Job, to make sure the
          Build Job was using a github-hosted runner.
        required: false
        default: https://github.com/ramonpetgrave/github-build-attestations-rw/.github/workflows/stub-workflow-do-not-trust.yml@refs/heads/dev
        type: string    
    outputs:
      build-artifact-id:
        description: >
          The artifact-id of the build artifacts. See the `download-artifact` Step for how to use.
        value: ${{ jobs.build.outputs.artifact-id }}
      attestation-artifact-id:
        description: >
          The artifact-id of the build attestations. See the `download-artifact` Step for how to use.
        value: ${{ jobs.sign.outputs.attestation-artifact-id }}

jobs:
  build:
    permissions:
      contents: read
      id-token: write
      attestations: write
    uses: ./.github/workflows/stub-workflow-do-not-trust.yml
    with: 
      build-runner-label: ${{ inputs.build-runner-label }}
      build-artifact-name: ${{ inputs.build-artifact-name }}
      subject-path: ${{ inputs.subject-path }}
      show-summary: ${{ inputs.show-summary }}
      build-github-token: ${{ inputs.build-github-token }}

  sign:
    outputs:
      attestation-artifact-id: ${{ steps.upload-attestation.outputs.artifact-id }}
    needs: build
    permissions:
      id-token: write
      attestations: write
    runs-on: ubuntu-latest
    steps:
      # actions/download-artifact@v4 does not yet support downloading via the immutable artifact-id,
      # but the Javascript library does. See: https://github.com/actions/download-artifact/issues/349
      - run: npm install @actions/artifact@2.1.9
      - name: download-stub
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          ARTIFACT_ID: ${{ needs.build.outputs.stub-artifact-id }}
        with:
          script: |
            const {default: artifactClient} = require('@actions/artifact')
            const { ARTIFACT_ID } = process.env
            await artifactClient.downloadArtifact(ARTIFACT_ID, { path: 'artifacts/'})
      - name: download-stub-attestation
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          ARTIFACT_ID: ${{ needs.build.outputs.stub-attestation-id }}
        with:
          script: |
            const {default: artifactClient} = require('@actions/artifact')
            const { ARTIFACT_ID } = process.env
            await artifactClient.downloadArtifact(ARTIFACT_ID, { path: 'attestations/'})
      - name: verify-stub
        env:
          SIGNER_WORKFLOW_CERT_IDENTITY: ${{ inputs.stub-workflow-cert-identity }}
          SOURCE_REPO: ${{ github.repository }}
          SOURCE_REF: ${{ github.ref }}
        run: |
          STUB=$( find ./artifacts -type f  | head -n 1 )
          ATT=$( find ./attestations -type f  | head -n 1 )
          gh attestation verify \
              $STUB \
              --bundle $ATT \
              --deny-self-hosted-runners \
              --repo "$SOURCE_REPO" \
              --cert-identity "$SIGNER_WORKFLOW_CERT_IDENTITY" \
              --format json --jq '.[].verificationResult.signature.certificate.sourceRepositoryRef' \
            | grep "^$SOURCE_REF$" \
          && rm -rf ./artifacts ./attestations
      - name: download-artifact
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          ARTIFACT_ID: ${{ needs.build.outputs.build-artifact-id }}
        with:
          script: |
            const {default: artifactClient} = require('@actions/artifact')
            const { ARTIFACT_ID } = process.env
            await artifactClient.downloadArtifact(ARTIFACT_ID, { path: 'artifacts/'})
      - run: ls -lahR
      - name: attest-build-provenance
        if: ${{ runner.environment == 'github-hosted' }}
        id: attest-build-provenance
        uses: actions/attest-build-provenance@310b0a4a3b0b78ef57ecda988ee04b132db73ef8 # v1.4.1
        with:
          subject-path: ./artifacts/*
          show-summary: ${{ inputs.show-summary }}
      - name: upload-attestation
        id: upload-attestation
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a #v4.3.6
        with:
          name: ${{ inputs.build-attestation-name }}
          path: ${{ steps.attest-build-provenance.outputs.bundle-path }}
          if-no-files-found: error

  test-verify:
    needs: [build, sign]
    runs-on: ubuntu-latest
    env:
      ARTIFACTS_FOLDER: ./artifacts
      ARTIFACT_ID: ${{ needs.build.outputs.build-artifact-id }}
      SOURCE_REPO: ${{ github.repository }}
      SOURCE_REF: ${{ github.ref }}
      SIGNER_WORKFLOW_CERT_IDENTITY: ${{ inputs.test-verify-signer-workflow-cert-identity }}
    steps:
      - name: detect-runner
        if: ${{ runner.environment != 'github-hosted' }}
        run: echo "self-hosted runner detected, failing job!" && exit 1
      - run: npm install @actions/artifact@2.1.9
      - name: download-artifact
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const {default: artifactClient} = require('@actions/artifact')
            const { ARTIFACT_ID, ARTIFACTS_FOLDER } = process.env
            await artifactClient.downloadArtifact(ARTIFACT_ID, { path: ARTIFACTS_FOLDER})
      - name: online-verify-with-cert-identity
        run: |
          for FILE in "$ARTIFACTS_FOLDER"/*; do
            gh attestation verify \
              $FILE \
              --deny-self-hosted-runners \
              --repo "$SOURCE_REPO" \
              --cert-identity "$SIGNER_WORKFLOW_CERT_IDENTITY" \
              --format json --jq '.[].verificationResult.signature.certificate.sourceRepositoryRef' \
            | grep "^$SOURCE_REF$"
          done